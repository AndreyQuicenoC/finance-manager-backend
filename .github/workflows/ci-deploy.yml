# .github/workflows/ci-deploy.yml
# CI/CD workflow for deployments to main branch
#
# Required secrets for deployment:
#   - RENDER_API_KEY: Render.com API key for deployment
#   - RENDER_SERVICE_ID: Render.com service ID to deploy
#
# Optional secrets:
#   - SONAR_TOKEN: SonarCloud authentication token (for code quality analysis)
#   - SONAR_PROJECT_KEY: SonarCloud project key
#   - SONAR_ORGANIZATION: SonarCloud organization name

name: CI/CD - Deploy on main

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    steps:
      # Checkout source code with full git history
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Set up Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # Run linting checks
      - name: Lint
        run: npm run lint

      # Run tests (placeholder for now, to be implemented by test owner)
      - name: Run tests (placeholder)
        run: |
          echo "Placeholder for tests - to be implemented by test owner"
          # Future implementation:
          # npm run test -- --coverage --watchAll=false --ci
          # or: npm test -- --coverage --ci

      # Build TypeScript project
      - name: Build
        run: npm run build

  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: build-and-test
    # Only deploy if build-and-test job succeeded
    if: needs.build-and-test.result == 'success'
    steps:
      # Checkout source code
      - name: Checkout
        uses: actions/checkout@v4

      # Deploy to Render if credentials are configured
      - name: Deploy to Render
        if: ${{ secrets.RENDER_API_KEY != '' && secrets.RENDER_SERVICE_ID != '' }}
        run: |
          echo "Deploying to Render service: ${{ secrets.RENDER_SERVICE_ID }}"
          curl -X POST "https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID }}" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}'
          echo "Deployment triggered successfully"

      # Log deployment status
      - name: Deployment status
        if: always()
        run: |
          status="${{ job.status }}"
          if [ "$status" == "success" ]; then
            echo "Deployment completed successfully"
          else
            echo "Deployment finished with status: ${status}"
          fi
